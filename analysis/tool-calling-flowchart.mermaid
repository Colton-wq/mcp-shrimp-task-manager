graph TD
    %% 用户输入和复杂度评估
    A[用户输入] --> B{复杂度评估}
    
    %% 三种调用路径
    B -->|简单任务<br/>< 500字符<br/>0-1依赖| C[execute_task]
    B -->|中等任务<br/>500-1000字符<br/>2-4依赖| D[plan_task]
    B -->|复杂任务<br/>> 1000字符<br/>5+依赖| D
    
    %% 深度调用路径
    D --> E[analyze_task]
    E --> F[reflect_task]
    F --> G[split_tasks]
    G --> H[(任务数据库)]
    H --> I[execute_task]
    
    %% 完成节点
    C --> J[任务完成]
    I --> J
    
    %% 支持系统
    K[提示词模板系统] --> D
    K --> E
    K --> F
    K --> G
    K --> I
    
    L[项目会话管理] --> D
    L --> E
    L --> F
    L --> G
    L --> I
    
    %% 认知偏见检测和强制搜索
    M[ConversationPatternDetector] --> N[force_search_protocol]
    N --> O[外部搜索验证]
    O --> E
    O --> F
    
    %% 数据流转
    P[Zod Schema验证] --> D
    P --> E
    P --> F
    P --> G
    P --> I
    
    %% 样式定义
    classDef userInput fill:#e1f5fe
    classDef simpleTask fill:#c8e6c9
    classDef complexTask fill:#ffecb3
    classDef database fill:#f3e5f5
    classDef support fill:#fff3e0
    classDef detection fill:#ffcdd2
    
    class A userInput
    class C simpleTask
    class D,E,F,G,I complexTask
    class H database
    class K,L,P support
    class M,N,O detection