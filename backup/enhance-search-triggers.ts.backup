import { z } from "zod";
import { ConversationPatternDetector } from "../intervention/conversationPatternDetector.js";

/**
 * å¢å¼ºæœç´¢è§¦å‘æœºåˆ¶ - ç¬¦åˆMCPè§„èŒƒçš„AIè¡Œä¸ºå¹²é¢„å·¥å…·
 * Enhanced Search Triggers - MCP-compliant AI Behavior Intervention Tool
 */

export const enhanceSearchTriggersSchema = z.object({
  userInput: z
    .string()
    .min(5, {
      message: "ç”¨æˆ·è¾“å…¥ä¸èƒ½å°‘äº5ä¸ªå­—ç¬¦ï¼Œè¯·æä¾›å®Œæ•´çš„ç”¨æˆ·é—®é¢˜æˆ–è¯·æ±‚",
    })
    .describe("ç”¨æˆ·çš„åŸå§‹è¾“å…¥æˆ–é—®é¢˜"),
  
  aiResponse: z
    .string()
    .min(10, {
      message: "AIå›ç­”ä¸èƒ½å°‘äº10ä¸ªå­—ç¬¦ï¼Œè¯·æä¾›AIçš„å®Œæ•´å›ç­”å†…å®¹",
    })
    .describe("AIåŠ©æ‰‹çš„å›ç­”å†…å®¹"),
  
  conversationHistory: z
    .string()
    .optional()
    .default("")
    .describe("å¯¹è¯å†å²ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰"),
  
  timeThreshold: z
    .number()
    .min(1)
    .max(60)
    .optional()
    .default(5)
    .describe("è§¦å‘æ—¶é—´é˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé»˜è®¤5åˆ†é’Ÿ"),
  
  enableProactiveMode: z
    .boolean()
    .optional()
    .default(true)
    .describe("æ˜¯å¦å¯ç”¨ä¸»åŠ¨è§¦å‘æ¨¡å¼"),
});

/**
 * æœç´¢ç­–ç•¥å¢å¼ºå™¨
 * Search Strategy Enhancer
 */
class SearchStrategyEnhancer {
  /**
   * ç”Ÿæˆå¢å¼ºçš„æœç´¢ç­–ç•¥
   * Generate enhanced search strategy
   */
  static generateEnhancedStrategy(
    analysis: ReturnType<typeof ConversationPatternDetector.analyzeConversationContext>,
    userInput: string
  ): {
    searchPriority: "IMMEDIATE" | "HIGH" | "MEDIUM" | "LOW";
    mcpToolSequence: Array<{
      tool: string;
      priority: number;
      parameters: Record<string, any>;
      rationale: string;
      timeout: number;
    }>;
    verificationCriteria: string[];
    qualityGates: string[];
  } {
    const searchPriority = this.determineSearchPriority(analysis);
    const mcpToolSequence = this.buildMCPToolSequence(analysis, userInput, searchPriority);
    const verificationCriteria = this.buildVerificationCriteria(analysis);
    const qualityGates = this.buildQualityGates(analysis);

    return {
      searchPriority,
      mcpToolSequence,
      verificationCriteria,
      qualityGates,
    };
  }

  private static determineSearchPriority(
    analysis: ReturnType<typeof ConversationPatternDetector.analyzeConversationContext>
  ): "IMMEDIATE" | "HIGH" | "MEDIUM" | "LOW" {
    if (analysis.overallRiskLevel === "CRITICAL") return "IMMEDIATE";
    if (analysis.overallRiskLevel === "HIGH") return "HIGH";
    if (analysis.overallRiskLevel === "MEDIUM") return "MEDIUM";
    return "LOW";
  }

  private static buildMCPToolSequence(
    analysis: ReturnType<typeof ConversationPatternDetector.analyzeConversationContext>,
    userInput: string,
    priority: "IMMEDIATE" | "HIGH" | "MEDIUM" | "LOW"
  ) {
    const sequence: Array<{
      tool: string;
      priority: number;
      parameters: Record<string, any>;
      rationale: string;
      timeout: number;
    }> = [];

    // æå–å…³é”®è¯
    const keywords = userInput
      .toLowerCase()
      .split(/\s+/)
      .filter(word => word.length > 3)
      .slice(0, 5);

    if (priority === "IMMEDIATE" || priority === "HIGH") {
      // é«˜ä¼˜å…ˆçº§ï¼šå¼ºåˆ¶å¤šæºæœç´¢
      sequence.push(
        {
          tool: "codebase-retrieval",
          priority: 1,
          parameters: {
            information_request: `${userInput} current implementation analysis`,
          },
          rationale: "ä¼˜å…ˆæ£€æŸ¥ç°æœ‰ä»£ç åº“å®ç°",
          timeout: 30000,
        },
        {
          tool: "web_search_exa_exa-mcp-server",
          priority: 2,
          parameters: {
            query: `${keywords.join(" ")} 2025 latest best practices`,
            numResults: 5,
          },
          rationale: "è·å–2025å¹´æœ€æ–°æœ€ä½³å®è·µ",
          timeout: 20000,
        },
        {
          tool: "github-local-search_code_mcphub-all-services",
          priority: 3,
          parameters: {
            q: `${keywords.join(" ")} language:typescript language:javascript`,
            per_page: 5,
          },
          rationale: "æŸ¥æ‰¾GitHubä¸Šçš„å®é™…ä»£ç å®ç°",
          timeout: 25000,
        },
        {
          tool: "tavily_search_tavily-remote-mcp",
          priority: 4,
          parameters: {
            query: `${userInput} troubleshooting guide 2025`,
            search_depth: "advanced",
            max_results: 3,
          },
          rationale: "æ·±åº¦æŠ€æœ¯æœç´¢å’Œæ•…éšœæ’é™¤",
          timeout: 30000,
        }
      );
    } else if (priority === "MEDIUM") {
      // ä¸­ç­‰ä¼˜å…ˆçº§ï¼šæ ‡å‡†éªŒè¯æœç´¢
      sequence.push(
        {
          tool: "codebase-retrieval",
          priority: 1,
          parameters: {
            information_request: userInput,
          },
          rationale: "æ£€æŸ¥ç°æœ‰ä»£ç åº“ç›¸å…³å®ç°",
          timeout: 20000,
        },
        {
          tool: "web_search_exa_exa-mcp-server",
          priority: 2,
          parameters: {
            query: `${keywords.join(" ")} best practices 2025`,
            numResults: 3,
          },
          rationale: "éªŒè¯æœ€ä½³å®è·µ",
          timeout: 15000,
        }
      );
    }

    return sequence;
  }

  private static buildVerificationCriteria(
    analysis: ReturnType<typeof ConversationPatternDetector.analyzeConversationContext>
  ): string[] {
    const criteria: string[] = [];

    if (analysis.overallRiskLevel === "CRITICAL" || analysis.overallRiskLevel === "HIGH") {
      criteria.push(
        "å¿…é¡»æä¾›è‡³å°‘3ä¸ªä¸åŒæ¥æºçš„2025å¹´æœ€æ–°ä¿¡æ¯",
        "å¿…é¡»åŒ…å«å…·ä½“çš„ä»£ç ç¤ºä¾‹æˆ–å®ç°æ¡ˆä¾‹",
        "å¿…é¡»éªŒè¯è§£å†³æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§å’Œæ—¶æ•ˆæ€§",
        "å¿…é¡»æä¾›æƒå¨æ¥æºçš„å®Œæ•´å¼•ç”¨"
      );
    } else {
      criteria.push(
        "å¿…é¡»æä¾›è‡³å°‘2ä¸ªæƒå¨æ¥æºçš„éªŒè¯",
        "å¿…é¡»ç¡®è®¤ä¿¡æ¯çš„æ—¶æ•ˆæ€§ï¼ˆ2025å¹´æœ‰æ•ˆï¼‰"
      );
    }

    return criteria;
  }

  private static buildQualityGates(
    analysis: ReturnType<typeof ConversationPatternDetector.analyzeConversationContext>
  ): string[] {
    const gates: string[] = [
      "æ‰€æœ‰æ¨èçš„MCPå·¥å…·è°ƒç”¨å¿…é¡»æˆåŠŸæ‰§è¡Œ",
      "æœç´¢ç»“æœå¿…é¡»åŒ…å«2025å¹´çš„æœ€æ–°ä¿¡æ¯",
      "å¿…é¡»æä¾›å…·ä½“çš„å®ç°æ–¹æ¡ˆè€Œéç†è®ºæè¿°",
    ];

    if (analysis.aiRisks.hasOverconfidence) {
      gates.push("å¿…é¡»æŒ‘æˆ˜æ‰€æœ‰è¿‡åº¦è‡ªä¿¡çš„å‡è®¾");
    }

    if (analysis.naturalTriggers.hasTechnicalProblem) {
      gates.push("å¿…é¡»æä¾›å…·ä½“çš„æ•…éšœæ’é™¤æ­¥éª¤");
    }

    if (analysis.naturalTriggers.hasTimeSensitivity) {
      gates.push("å¿…é¡»ä¼˜å…ˆæä¾›æœ€æ–°çš„è§£å†³æ–¹æ¡ˆ");
    }

    return gates;
  }
}

/**
 * å¢å¼ºæœç´¢è§¦å‘æœºåˆ¶ä¸»å‡½æ•°
 * Enhanced Search Triggers Main Function
 */
export async function enhanceSearchTriggers({
  userInput,
  aiResponse,
  conversationHistory = "",
  timeThreshold = 5,
  enableProactiveMode = true,
}: z.infer<typeof enhanceSearchTriggersSchema>) {
  // æ‰§è¡Œå¯¹è¯æ¨¡å¼åˆ†æ
  const analysis = ConversationPatternDetector.analyzeConversationContext(
    userInput,
    aiResponse,
    conversationHistory
  );

  // ç”Ÿæˆå¢å¼ºæœç´¢ç­–ç•¥
  const strategy = SearchStrategyEnhancer.generateEnhancedStrategy(analysis, userInput);

  // æ„å»ºå“åº”
  const response = {
    analysisResult: {
      overallRiskLevel: analysis.overallRiskLevel,
      recommendedIntervention: analysis.recommendedIntervention,
      interventionReason: analysis.interventionReason,
      naturalTriggers: {
        detected: analysis.naturalTriggers.detectedPatterns,
        score: analysis.naturalTriggers.triggerScore,
        action: analysis.naturalTriggers.recommendedAction,
      },
      aiRisks: {
        detected: analysis.aiRisks.detectedRisks,
        score: analysis.aiRisks.riskScore,
        interventionRequired: analysis.aiRisks.interventionRequired,
      },
    },
    enhancedStrategy: {
      searchPriority: strategy.searchPriority,
      mcpToolSequence: strategy.mcpToolSequence,
      verificationCriteria: strategy.verificationCriteria,
      qualityGates: strategy.qualityGates,
    },
    triggerRecommendations: {
      immediateAction: strategy.searchPriority === "IMMEDIATE" || strategy.searchPriority === "HIGH",
      proactiveMode: enableProactiveMode,
      timeThreshold: timeThreshold,
      nextSteps: strategy.searchPriority === "IMMEDIATE" 
        ? "ç«‹å³æ‰§è¡Œå¼ºåˆ¶æœç´¢ï¼Œæš‚åœå½“å‰å›ç­”ç›´åˆ°éªŒè¯å®Œæˆ"
        : strategy.searchPriority === "HIGH"
        ? "å¼ºçƒˆå»ºè®®æ‰§è¡Œæœç´¢éªŒè¯ï¼Œç„¶åç»§ç»­å›ç­”"
        : "å»ºè®®ç›‘æ§åç»­å¯¹è¯ï¼Œå¿…è¦æ—¶è§¦å‘éªŒè¯",
    },
  };

  return {
    content: [
      {
        type: "text" as const,
        text: `# Enhanced Search Triggers v3.0 åˆ†æç»“æœ

## ğŸš¨ é£é™©è¯„ä¼°
- **æ€»ä½“é£é™©çº§åˆ«**: ${response.analysisResult.overallRiskLevel}
- **æ¨èå¹²é¢„æªæ–½**: ${response.analysisResult.recommendedIntervention}
- **å¹²é¢„åŸå› **: ${response.analysisResult.interventionReason}

## ğŸ” è‡ªç„¶è§¦å‘æ¨¡å¼æ£€æµ‹
- **æ£€æµ‹åˆ°çš„æ¨¡å¼**: ${response.analysisResult.naturalTriggers.detected.join("; ")}
- **è§¦å‘è¯„åˆ†**: ${response.analysisResult.naturalTriggers.score}/10
- **æ¨èè¡ŒåŠ¨**: ${response.analysisResult.naturalTriggers.action}

## âš ï¸ AIé£é™©æ¨¡å¼æ£€æµ‹
- **æ£€æµ‹åˆ°çš„é£é™©**: ${response.analysisResult.aiRisks.detected.join("; ")}
- **é£é™©è¯„åˆ†**: ${response.analysisResult.aiRisks.score}/10
- **éœ€è¦å¹²é¢„**: ${response.analysisResult.aiRisks.interventionRequired ? "æ˜¯" : "å¦"}

## ğŸš€ å¢å¼ºæœç´¢ç­–ç•¥
- **æœç´¢ä¼˜å…ˆçº§**: ${response.enhancedStrategy.searchPriority}

### MCPå·¥å…·æ‰§è¡Œåºåˆ—
${response.enhancedStrategy.mcpToolSequence.map(tool => 
  `${tool.priority}. **${tool.tool}**
   - å‚æ•°: ${JSON.stringify(tool.parameters, null, 2)}
   - ç†ç”±: ${tool.rationale}
   - è¶…æ—¶: ${tool.timeout}ms`
).join("\n\n")}

## âœ… éªŒè¯æ ‡å‡†
${response.enhancedStrategy.verificationCriteria.map(criteria => `- ${criteria}`).join("\n")}

## ğŸ¯ è´¨é‡é—¨æ§
${response.enhancedStrategy.qualityGates.map(gate => `- ${gate}`).join("\n")}

## ğŸ”„ è§¦å‘å»ºè®®
- **ç«‹å³è¡ŒåŠ¨**: ${response.triggerRecommendations.immediateAction ? "æ˜¯" : "å¦"}
- **ä¸»åŠ¨æ¨¡å¼**: ${response.triggerRecommendations.proactiveMode ? "å¯ç”¨" : "ç¦ç”¨"}
- **æ—¶é—´é˜ˆå€¼**: ${response.triggerRecommendations.timeThreshold}åˆ†é’Ÿ
- **ä¸‹ä¸€æ­¥**: ${response.triggerRecommendations.nextSteps}

---
**é‡è¦æé†’**: æ­¤å·¥å…·æ£€æµ‹åˆ°éœ€è¦å¢å¼ºæœç´¢éªŒè¯çš„æ¨¡å¼ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç­–ç•¥æ‰§è¡Œï¼Œç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§ã€‚`,
      },
    ],
  };
}